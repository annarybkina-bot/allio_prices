# Техническое задание: Группировка квартир по сопоставимым параметрам

## 1. Описание задачи

Необходимо разработать скрипт для анализа и группировки квартир из разных жилых комплексов (ЖК) по сопоставимым параметрам. Скрипт должен обрабатывать CSV файлы с данными о квартирах, нормализовать данные, группировать квартиры по заданным критериям и выводить результат в CSV файл.

## 2. Входные данные

### 2.1. Формат файлов
- **Формат**: CSV файлы с кодировкой UTF-8 или Windows-1251
- **Разделитель**: запятая
- **Кодировка десятичных чисел**: запятая (например, "50,5" вместо "50.5")

### 2.2. Структура входных CSV файлов

Каждый CSV файл должен содержать следующие колонки:
- `Этаж` - номер этажа (число)
- `Комнатность` - количество комнат (например, "1к", "2к", "2К", "студия")
  - **Примечание**: Название колонки может содержать пробелы в начале или конце (например, "Комнатность "), которые автоматически удаляются при обработке
  - **Примечание**: Значение "студия" обрабатывается как "1к" (1 комната)
- `Вид из окон` или `Вид из окна` - вид из окон (например, "Во двор", "На улицу", "Во двор и на улицу")
  - **Примечание**: Поддерживаются оба варианта названия колонки (единственное и множественное число)
  - **Примечание**: Пустые значения обрабатываются как "на улицу" (значение по умолчанию)
- `Стоимость` - стоимость квартиры (число)
  - **Примечание**: Может содержать пробелы как разделители тысяч (например, "20 458 395"), которые автоматически удаляются при обработке
- `Общая площадь (м.кв.)` или `Общая площадь` - площадь квартиры (число с запятой, например "50,5")
  - **Примечание**: Поддерживаются оба варианта названия колонки (с указанием единиц измерения и без)

**Дополнительные колонки** (если есть) игнорируются.

### 2.3. Типы файлов

1. **Основной ЖК** - файл с названием "Мой ЖК.csv"
2. **Конкуренты** - файлы с названиями:
   - "Конкурент Вдохновение.csv"
   - "Конкурент Ривьера.csv"

## 3. Нормализация данных

Перед группировкой все данные должны быть нормализованы:

### 3.1. Нормализация этажа
- **Правило**: Преобразовать в два значения: "первый" или "не первый"
- **Логика**: 
  - Если этаж = 1 → "первый"
  - Если этаж > 1 → "не первый"
- **Примеры**: 
  - "1" → "первый"
  - "2", "5", "10", "16" → "не первый"

### 3.2. Нормализация комнатности
- **Правило**: Привести к единому формату "Nк" (где N - число комнат)
- **Логика**:
  - Если значение содержит "студи" (в любом регистре) → "1к"
  - Иначе извлечь число из строки (игнорировать регистр и дополнительные символы)
  - Формат результата: "1к", "2к", "3к" и т.д.
- **Примеры**:
  - "студия" → "1к"
  - "Студия" → "1к"
  - "1к" → "1к"
  - "2к" → "2к"
  - "2К" → "2к"
  - "1 комнатная" → "1к"

### 3.3. Нормализация вида из окон
- **Правило**: Привести к двум значениям: "во двор" или "на улицу"
- **Логика**:
  - Если поле пустое или содержит только пробелы → "на улицу" (значение по умолчанию)
  - Если содержит "во двор" И НЕ содержит "на улицу" → "во двор"
  - Во всех остальных случаях (содержит "на улицу" или оба варианта) → "на улицу"
- **Примеры**:
  - "" (пустое) → "на улицу"
  - "Во двор" → "во двор"
  - "На улицу" → "на улицу"
  - "Во двор и на улицу" → "на улицу"

### 3.4. Нормализация площади
- **Правило**: Группировать с шагом 10 м², результат в формате "N-M" (где N - нижняя граница, M - верхняя)
- **Логика**:
  - Заменить запятую на точку для парсинга
  - Округлить вниз до шага 10 м² (например, 50.5 → 50, 55.2 → 50, 65.8 → 60)
  - Верхняя граница = нижняя граница + 10
- **Примеры**:
  - "32,95" → "30-40"
  - "50,5" → "50-60"
  - "65,8" → "60-70"
  - "49,76" → "40-50"

### 3.5. Нормализация стоимости
- **Правило**: Преобразовать в целое число
- **Логика**: 
  - Удалить все пробелы (включая неразрывные пробелы `\xa0`), используемые как разделители тысяч
  - Заменить запятую на точку для парсинга (если используется как десятичный разделитель)
  - Преобразовать в float, затем в int
- **Примеры**:
  - "3 130 250" → 3130250
  - "20 458 395" → 20458395
  - "5755200" → 5755200
  - "3,130,250" → 3130250 (после удаления запятых)

## 4. Алгоритм группировки

### 4.1. Ключ группировки

Квартиры группируются по следующему ключу (в указанном порядке):
1. **Комнатность** (нормализованная)
2. **Этаж** (нормализованный: "первый" или "не первый")
3. **Вид** (нормализованный: "во двор" или "на улицу")
4. **Площадь** (нормализованная: диапазон "N-M")

**Важно**: Конкретные номера этажей (2, 3, 5, 10 и т.д.) НЕ участвуют в группировке. Все квартиры с этажами > 1 попадают в одну группу "не первый этаж", если остальные параметры совпадают.

### 4.2. Обработка источников

1. **Основной ЖК ("Мой ЖК")**: обрабатывается отдельно, создается группа "Мой ЖК"
2. **Конкуренты**: все файлы конкурентов объединяются в одну группу "Все конкуренты"
   - Квартиры из разных файлов конкурентов объединяются по одинаковым ключам группировки
   - НЕ создавать отдельные группы для каждого конкурента

### 4.3. Сортировка внутри групп

После группировки квартиры внутри каждой группы должны быть отсортированы по стоимости (по возрастанию).

## 5. Выходные данные

### 5.1. Формат выходного файла

- **Имя файла**: `Группы_сводка.csv`
- **Кодировка**: UTF-8 с BOM (для корректного отображения в Excel)
- **Разделитель**: запятая

### 5.2. Структура выходного CSV

Каждая строка представляет одну группу квартир со следующими колонками:

1. **Источник** - название источника данных ("Мой ЖК" или "Все конкуренты")
2. **Комнатность** - нормализованная комнатность (например, "1к", "2к")
3. **Этаж** - нормализованный этаж ("первый" или "не первый")
4. **Вид** - нормализованный вид ("во двор" или "на улицу")
5. **Площадь_диапазон** - диапазон площади (например, "30-40 м²")
6. **Количество_квартир** - количество квартир в группе
7. **Мин_стоимость** - минимальная стоимость в группе
8. **Макс_стоимость** - максимальная стоимость в группе
9. **Средняя_стоимость** - средняя стоимость в группе (округлить до целого)

### 5.3. Сортировка выходных данных

Группы должны быть отсортированы в следующем порядке:
1. Источник (сначала "Мой ЖК", потом "Все конкуренты")
2. Комнатность (1к, затем 2к, и т.д.)
3. Этаж (первый, затем не первый)
4. Вид (во двор, затем на улицу)
5. Площадь (по возрастанию нижней границы диапазона)

## 6. Примеры

### 6.1. Пример входных данных

```csv
Этаж,Комнатность,Вид из окон,Стоимость,Общая площадь (м.кв.)
2,1к,На улицу,3130250,32,95
5,1к,На улицу,3440000,35,2
10,2к,Во двор,5672640,49,76
```

### 6.2. Пример выходных данных

```csv
Источник,Комнатность,Этаж,Вид,Площадь_диапазон,Количество_квартир,Мин_стоимость,Макс_стоимость,Средняя_стоимость
Мой ЖК,1к,не первый,на улицу,30-40 м²,180,3130250,5755200,4818255
Мой ЖК,2к,не первый,во двор,40-50 м²,89,4403760,7115680,6133059
Все конкуренты,1к,не первый,на улицу,30-40 м²,33,5731500,8938800,7113928
```

## 7. Требования к обработке ошибок

1. **Отсутствие файлов**: Если файл не найден, вывести сообщение об ошибке, но продолжить обработку остальных файлов
2. **Некорректные данные**: Строки с пустыми или некорректными критическими полями (этаж, комнатность, площадь, стоимость) должны быть пропущены. Пустые значения поля "Вид из окон" обрабатываются как "на улицу" (значение по умолчанию)
3. **Кодировка**: Поддерживать автоматическое определение кодировки (UTF-8, CP1251, Windows-1251)
4. **Нормализация названий колонок**: 
   - Автоматически удалять пробелы в начале и конце названий всех колонок при чтении CSV
   - Это позволяет корректно обрабатывать файлы с названиями колонок типа "Комнатность " (с пробелом в конце)
   - Пример: "Комнатность " → "Комнатность", " Этаж " → "Этаж"
5. **Поддержка альтернативных названий колонок**:
   - Система автоматически распознает альтернативные варианты названий колонок:
     - `Общая площадь` или `Общая площадь (м.кв.)` - для площади
     - `Вид из окна` или `Вид из окон` - для вида из окон
   - При отсутствии одного варианта используется альтернативный

## 8. Дополнительные требования

1. **Производительность**: Скрипт должен обрабатывать файлы с несколькими тысячами записей
2. **Читаемость кода**: Код должен быть структурирован, с комментариями на русском языке
3. **Вывод в консоль**: Скрипт должен выводить информацию о процессе обработки (какие файлы обрабатываются, сколько групп создано)

## 9. Технические детали реализации

### 9.1. Рекомендуемые библиотеки
- `csv` (стандартная библиотека Python) - для работы с CSV файлами
- `re` (стандартная библиотека Python) - для нормализации данных
- `collections.defaultdict` - для группировки данных

### 9.2. Структура кода

Рекомендуемая структура функций:
1. `normalize_floor(floor)` - нормализация этажа
2. `normalize_rooms(rooms)` - нормализация комнатности
3. `normalize_view(view)` - нормализация вида
4. `normalize_area(area)` - нормализация площади
5. `normalize_price(price)` - нормализация стоимости
6. `load_and_normalize_csv(file_path)` - загрузка и нормализация данных из CSV
7. `group_apartments(apartments, source_name)` - группировка квартир
8. `save_groups_summary_to_csv(all_groups_dict, output_path)` - сохранение результата
9. `main()` - основная функция

## 10. Критерии приемки

Скрипт считается выполненным корректно, если:

1. ✅ Корректно обрабатывает все входные CSV файлы
2. ✅ Правильно нормализует все данные согласно требованиям
3. ✅ Группирует квартиры только по нормализованному этажу (первый/не первый), без учета конкретных номеров этажей
4. ✅ Объединяет всех конкурентов в одну группу "Все конкуренты"
5. ✅ Создает один выходной файл `Группы_сводка.csv` с корректной структурой
6. ✅ Сортирует квартиры внутри групп по стоимости
7. ✅ Сортирует группы в выходном файле согласно требованиям
8. ✅ Вычисляет статистику (мин, макс, средняя стоимость) для каждой группы

## 11. Контрольные примеры

### Пример 1: Группировка по этажам
**Входные данные:**
- Квартира 1: этаж 2, 1к, на улицу, 30 м²
- Квартира 2: этаж 5, 1к, на улицу, 30 м²
- Квартира 3: этаж 10, 1к, на улицу, 30 м²

**Ожидаемый результат:** Все три квартиры попадают в одну группу "1к, не первый, на улицу, 30-40 м²"

### Пример 2: Группировка по площади
**Входные данные:**
- Квартира 1: площадь 32,95 м²
- Квартира 2: площадь 35,2 м²
- Квартира 3: площадь 38,5 м²

**Ожидаемый результат:** Все три квартиры попадают в одну группу с диапазоном "30-40 м²"

### Пример 3: Объединение конкурентов
**Входные данные:**
- Файл "Конкурент Вдохновение.csv": квартира 1к, не первый, на улицу, 40-50 м²
- Файл "Конкурент Ривьера.csv": квартира 1к, не первый, на улицу, 40-50 м²

**Ожидаемый результат:** Обе квартиры попадают в одну группу "Все конкуренты, 1к, не первый, на улицу, 40-50 м²"

## 12. Веб-приложение

### 12.1. Общее описание

Необходимо разработать веб-приложение на Flask для интерактивного анализа и группировки квартир. Приложение должно работать локально и предоставлять пользовательский интерфейс для загрузки файлов, просмотра групп и сравнения сопоставимых групп.

### 12.2. Технологический стек

- **Backend**: Flask (Python)
- **Frontend**: HTML, CSS, JavaScript (vanilla)
- **Визуализация**: matplotlib (генерация графиков на сервере, передача в base64)
- **Зависимости**: flask, matplotlib, numpy

### 12.3. Структура интерфейса

#### 12.3.1. Раздел 1: Загрузка файлов

**Элементы интерфейса:**
1. **Поле загрузки файла основного ЖК** (обязательное)
   - Тип: file input
   - Принимает: CSV файлы
   - Подпись: "Файл основного ЖК:"

2. **Поле загрузки файлов конкурентов** (опциональное, множественный выбор)
   - Тип: file input с атрибутом `multiple`
   - Принимает: CSV файлы
   - Подпись: "Файлы конкурентов (можно выбрать несколько):"

3. **Кнопка "Создать группы"**
   - При нажатии отправляет файлы на сервер
   - Показывает индикатор загрузки во время обработки
   - Отображает ошибки, если они возникли

#### 12.3.2. Раздел 2: Список созданных групп

**Отображение групп:**
- Группы отображаются в виде **сводной таблицы** (pivot table)
- **Столбцы**: Источники данных (например, "Мой ЖК", "Все конкуренты")
- **Строки**: Названия групп в формате "Комнатность, Этаж, Вид, Площадь м²"
  - Пример: "1к, не первый, на улицу, 30-40 м²"
- **Ячейки**: Количество квартир в группе для каждого источника
  - Если группы нет для источника - отображается "-"
  - Ячейки с данными подсвечиваются зеленым

**Кнопка "Сравнить сопоставимые группы"**
- Появляется только если найдены сопоставимые группы (одинаковые параметры, разные источники)
- При нажатии запускает статистический анализ

#### 12.3.3. Раздел 3: Результаты сравнения

**Для каждой пары сопоставимых групп отображается:**

1. **Заголовок группы** (крупный, выделенный)
   - Формат: "Комнатность, Этаж, Вид, Площадь м²"
   - Пример: "2к, не первый, на улицу, 70-80 м²"
   - Стиль: крупный шрифт, градиентный фон, левая рамка

2. **Таблица статистики**
   - **Столбцы**: Источники (например, "Мой ЖК", "Все конкуренты")
   - **Строки**: Показатели
     - Среднее
     - Медиана
     - Минимум
     - Максимум
     - Выбросы (всего)
     - Выбросы снизу (количество и значения)
     - Выбросы сверху (количество и значения)
   - **Стиль**: Градиентный заголовок, первая колонка (показатели) выделена
   - Значения выбросов отображаются мелким курсивом под количеством
   - **Процентная разница для основного ЖК**:
     - Для каждого показателя (среднее, медиана, минимум, максимум) в колонке основного ЖК отображается процентная разница относительно конкурентов
     - Формула: `((значение_основного_ЖК - значение_конкурентов) / значение_конкурентов) × 100%`
     - Формат отображения: `13 653 490 руб. (+5.0%)` или `13 653 490 руб. (-2.5%)`
     - **Цветовая индикация**:
       - **Зеленый цвет** (фон и текст) - если процент отрицательный (основной ЖК дешевле конкурентов)
       - **Красный цвет** (фон и текст) - если процент положительный (основной ЖК дороже конкурентов)
     - Процентная разница отображается только для основного ЖК, для конкурентов не показывается

3. **Графики** (два графика рядом):
   
   **a) Boxplot (слева)**
   - Два boxplot рядом для визуального сравнения
   - Показывает медиану (красная линия), среднее (зеленая пунктирная)
   - Выбросы отмечены оранжевыми точками
   - Заголовок: "Сравнение стоимости" (без параметров группы)
   
   **b) Гистограмма (справа)**
   - Две наложенные гистограммы с прозрачностью
   - Шаг гистограммы: 15 бинов (крупный шаг)
   - Вертикальные линии: средние и медианы для каждой группы
   - Заголовок: "Распределение стоимости" (без параметров группы)

### 12.4. API Endpoints

#### 12.4.1. `GET /`
- Возвращает главную страницу (HTML)

#### 12.4.2. `POST /api/create_groups`
- **Входные данные**: 
  - `main_file` (file) - файл основного ЖК
  - `competitor_files` (files, multiple) - файлы конкурентов
- **Выходные данные**: JSON
  ```json
  {
    "groups": [
      {
        "id": "main_0",
        "source": "Мой ЖК",
        "комнатность": "1к",
        "этаж": "не первый",
        "вид": "на улицу",
        "площадь": "30-40",
        "количество": 180,
        "costs": [3130250, 3196150, ...],
        "stats": {
          "mean": 4818255,
          "median": 4706475,
          "min": 3130250,
          "max": 5755200,
          "outliers_lower": [3130250],
          "outliers_upper": [5755200],
          "outliers_lower_count": 1,
          "outliers_upper_count": 1,
          "outliers_count": 2
        }
      }
    ]
  }
  ```

#### 12.4.3. `POST /api/compare_groups`
- **Входные данные**: JSON
  ```json
  {
    "groups": [/* массив групп из предыдущего запроса */]
  }
  ```
- **Выходные данные**: JSON
  ```json
  {
    "comparisons": [
      {
        "group1": {
          "source": "Мой ЖК",
          "stats": {/* статистика */}
        },
        "group2": {
          "source": "Все конкуренты",
          "stats": {/* статистика */}
        },
        "parameters": {
          "комнатность": "2к",
          "этаж": "не первый",
          "вид": "на улицу",
          "площадь": "70-80"
        },
        "percentage_diffs": {
          "mean": 5.0,
          "median": 4.5,
          "min": 3.2,
          "max": 6.1
        },
        "main_source": "Мой ЖК",
        "boxplot": "base64_encoded_image",
        "histogram": "base64_encoded_image"
      }
    ]
  }
  ```

### 12.5. Статистический анализ

#### 12.5.1. Вычисляемые показатели

Для каждой группы вычисляются:
- **Среднее значение** (mean)
- **Медиана** (median)
- **Минимум** (min)
- **Максимум** (max)
- **Стандартное отклонение** (std)
- **Квартили**: Q1 (25%), Q3 (75%)
- **Межквартильный размах** (IQR = Q3 - Q1)

#### 12.5.2. Выбросы

Выбросы определяются по правилу **1.5 × IQR**:
- **Нижняя граница**: Q1 - 1.5 × IQR
- **Верхняя граница**: Q3 + 1.5 × IQR
- **Выбросы снизу**: значения < нижней границы
- **Выбросы сверху**: значения > верхней границы

Выбросы разделяются на две категории:
- **Выбросы снизу** (дешевые квартиры) - отображаются отдельной строкой в таблице
- **Выбросы сверху** (дорогие квартиры) - отображаются отдельной строкой в таблице

#### 12.5.3. Процентная разница

Для каждой пары сопоставимых групп вычисляется процентная разница показателей основного ЖК относительно конкурентов:

- **Формула**: `((значение_основного_ЖК - значение_конкурентов) / значение_конкурентов) × 100%`
- **Вычисляется для**: среднее, медиана, минимум, максимум
- **Интерпретация**:
  - Отрицательное значение: основной ЖК дешевле конкурентов (хорошо)
  - Положительное значение: основной ЖК дороже конкурентов (плохо)
- **Округление**: до 2 знаков после запятой

### 12.6. Визуализация

#### 12.6.1. Boxplot

**Параметры:**
- Два boxplot рядом (вертикальная ориентация)
- Цвета: светло-голубой и коралловый
- Медиана: красная линия
- Среднее: зеленая пунктирная линия
- Выбросы: оранжевые точки
- Ось Y: стоимость в рублях с форматированием
- Заголовок: "Сравнение стоимости" (без параметров группы)

#### 12.6.2. Гистограмма

**Параметры:**
- Две наложенные гистограммы с прозрачностью (alpha=0.6)
- Количество бинов: 15 (крупный шаг)
- **Важно**: Обе гистограммы используют **одинаковые границы бинов**, вычисленные на основе общего диапазона данных обеих групп (от минимума до максимума всех значений). Это обеспечивает корректное визуальное сравнение распределений.
- Цвета: стальной синий и коралловый
- Вертикальные линии: средние (пунктир) и медианы (сплошные)
- Ось X: стоимость в рублях (формат: "X.XМ")
- Ось Y: количество квартир
- Заголовок: "Распределение стоимости" (без параметров группы)

### 12.7. Требования к интерфейсу

1. **Адаптивность**: Интерфейс должен корректно отображаться на разных размерах экрана
2. **Индикатор загрузки**: Показывать спиннер и сообщение "Обработка данных..." во время обработки
3. **Обработка ошибок**: Отображать сообщения об ошибках в красном блоке
4. **Плавная прокрутка**: При появлении результатов сравнения автоматически прокручивать к ним
5. **Валидация**: Проверять наличие обязательного файла основного ЖК перед отправкой

### 12.8. Стилизация

**Цветовая схема:**
- Основной цвет: #667eea (синий)
- Вторичный цвет: #764ba2 (фиолетовый)
- Градиент фона: от #667eea до #764ba2
- Таблицы: белый фон, градиентные заголовки
- Выделение: зеленый для ячеек с данными
- **Процентная разница**:
  - Зеленый (#2e7d32) с фоном (#e8f5e9) - для отрицательных процентов (дешевле)
  - Красный (#c62828) с фоном (#ffebee) - для положительных процентов (дороже)

**Типографика:**
- Шрифт: системный (-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto)
- Заголовки: жирные, увеличенный размер
- Таблицы: читаемый размер шрифта, четкие границы

### 12.9. Особенности реализации

1. **Графики**: Генерируются на сервере с помощью matplotlib, конвертируются в base64 и передаются в HTML
2. **Данные не сохраняются**: Все данные обрабатываются в памяти, ничего не логируется и не сохраняется на диск
3. **Локальная работа**: Приложение работает только локально, без внешних зависимостей
4. **Автоматическое определение сопоставимых групп**: Система автоматически находит группы с одинаковыми параметрами, но разными источниками

### 12.10. Критерии приемки веб-приложения

Веб-приложение считается выполненным корректно, если:

1. ✅ Корректно загружает и обрабатывает CSV файлы через веб-интерфейс
2. ✅ Отображает группы в виде сводной таблицы (столбцы - источники, строки - группы, ячейки - количество)
3. ✅ Находит и отображает сопоставимые группы
4. ✅ Генерирует и отображает boxplot для каждой пары сопоставимых групп
5. ✅ Генерирует и отображает гистограммы для каждой пары сопоставимых групп с одинаковыми границами бинов
6. ✅ Отображает статистику в виде таблицы с разделением выбросов на верхние и нижние
7. ✅ Заголовок группы вынесен отдельно, не дублируется в заголовках графиков
8. ✅ Вычисляет и отображает процентную разницу для основного ЖК с цветовой индикацией (зеленый - дешевле, красный - дороже)
9. ✅ Корректно обрабатывает ошибки и отображает сообщения пользователю
10. ✅ Работает локально без необходимости сохранения данных

---

**Дата создания ТЗ:** 30.12.2024  
**Версия:** 2.3 (добавлены требования к поддержке альтернативных названий колонок и обработке "студии" как 1 комнаты)

