<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ç–æ—Ç–∏–ø –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .prototype-container {
            position: relative;
            max-width: 100%;
            max-height: 100vh;
            display: inline-block;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .screenshot {
            display: block;
            max-width: 100%;
            height: auto;
            width: 100%;
        }

        .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 600px;
            width: 100%;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border: 2px dashed #ccc;
        }

        .placeholder-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .placeholder-content p {
            margin: 10px 0;
            font-size: 18px;
            color: #666;
        }

        .placeholder-content p:first-child {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .placeholder-text {
            font-size: 14px !important;
            color: #999;
            margin-top: 20px;
        }

        .placeholder-text strong {
            color: #333;
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
        }

        #file-input {
            margin-top: 15px;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            background: white;
            font-size: 14px;
            transition: all 0.3s;
        }

        #file-input:hover {
            border-color: #5568d3;
            background: #f8f9ff;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ +1 —Ä—è–¥–æ–º —Å –∏–∫–æ–Ω–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
        .notification-badge {
            position: absolute;
            top: 15px;
            right: 140px; /* –ü–æ–∑–∏—Ü–∏—è —Ä—è–¥–æ–º —Å –∏–∫–æ–Ω–∫–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É */
            background: #FF4444;
            color: white;
            border-radius: 12px;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
            z-index: 1000;
            border: 2px solid white;
            animation: pulse 2s infinite;
            line-height: 1;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .notification-badge:hover {
            transform: scale(1.1);
        }

        /* –ü–æ–ø–∞–ø —á–∞—Ç–∞ */
        .chat-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .chat-popup-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .chat-popup {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s;
            position: relative;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-body {
            padding: 24px 20px;
        }

        .chat-message {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.5;
            color: #333;
        }

        .chat-buttons {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        .chat-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .chat-button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .chat-button-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .chat-button-secondary:hover {
            background: #e0e0e0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ */
        .analysis-message {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 15px;
            line-height: 1.8;
            color: #333;
            max-height: 60vh;
            overflow-y: auto;
        }

        .analysis-message p {
            margin: 12px 0;
        }

        .analysis-groups {
            margin: 16px 0;
            padding-left: 20px;
        }

        .analysis-groups li {
            margin: 8px 0;
            line-height: 1.6;
        }

        .price-diff {
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .price-diff.positive {
            color: #c62828;
            background: #ffebee;
        }

        .price-diff.negative {
            color: #2e7d32;
            background: #e8f5e9;
        }

        .chat-scrollable {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .chat-input-container {
            border-top: 1px solid #e0e0e0;
            padding: 16px 20px;
            background: #fafafa;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .chat-send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .chat-send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ */
        .chat-messages {
            max-height: 50vh;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 0;
        }

        .message {
            margin-bottom: 16px;
            animation: fadeInMessage 0.3s;
        }

        @keyframes fadeInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            text-align: right;
        }

        .message-bot {
            text-align: left;
        }

        .message-bubble {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bot .message-bubble {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 2px 12px rgba(255, 68, 68, 0.7);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 2px 8px rgba(255, 68, 68, 0.4);
            }
        }

        /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è - –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ */
        .notification-badge.alt-position {
            top: 15px;
            right: 140px;
        }
    </style>
</head>
<body>
    <div class="prototype-container">
        <img id="screenshot-img" src="{{ url_for('static', filename='screenshot.png') }}" alt="–°–∫—Ä–∏–Ω—à–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞" class="screenshot" 
             onerror="showPlaceholder()">
        <div id="placeholder" class="placeholder" style="display: none;">
            <div class="placeholder-content">
                <p>üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
                <p class="placeholder-text">–ü–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª <strong>screenshot.png</strong> –≤ –ø–∞–ø–∫—É <strong>static/</strong></p>
                <p class="placeholder-text">–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∏–∂–µ:</p>
                <input type="file" id="file-input" accept="image/*">
            </div>
        </div>
        <div class="notification-badge" onclick="openChatPopup()">+1</div>
    </div>

    <!-- –ü–æ–ø–∞–ø —á–∞—Ç–∞ -->
    <div id="chatPopup" class="chat-popup-overlay" onclick="closeChatPopupOnOverlay(event)">
        <div class="chat-popup" onclick="event.stopPropagation()">
            <div class="chat-header">
                <h3>–°–æ–æ–±—â–µ–Ω–∏–µ</h3>
                <button class="chat-close" onclick="closeChatPopup()">&times;</button>
            </div>
            <div class="chat-body" id="chatBody">
                <div id="chatMessagesContainer" class="chat-messages" style="display: none;">
                    <div id="chatMessages"></div>
                </div>
                <div id="initialContent">
                    <div class="chat-message" id="initialMessage">
                        –ü—Ä–∏–≤–µ—Ç!<br>
                        –£ –º–µ–Ω—è –≥–æ—Ç–æ–≤ —Å–≤–µ–∂–∏–π –∞–Ω–∞–ª–∏–∑ —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –ü–æ–∫–∞–∑–∞—Ç—å?
                    </div>
                    <div class="chat-buttons" id="initialButtons">
                        <button class="chat-button chat-button-primary" onclick="handleShowAnalysis()">
                            –ö–æ–Ω–µ—á–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–π
                        </button>
                        <button class="chat-button chat-button-secondary" onclick="closeChatPopup()">
                            –Ω–µ –Ω–∞–¥–æ
                        </button>
                    </div>
                </div>
                <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                    <input type="text" id="chatInput" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatInputKeyPress(event)">
                    <button class="chat-send-button" id="chatSendButton" onclick="sendUserMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showPlaceholder() {
            const img = document.getElementById('screenshot-img');
            const placeholder = document.getElementById('placeholder');
            if (img && placeholder) {
                img.style.display = 'none';
                placeholder.style.display = 'flex';
            }
        }
        
        function hidePlaceholder() {
            const img = document.getElementById('screenshot-img');
            const placeholder = document.getElementById('placeholder');
            if (img && placeholder) {
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }
        
        function loadImageFromFile(file) {
            if (file && file.type.startsWith('image/')) {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ FileReader –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('screenshot-img');
                    if (img) {
                        img.src = e.target.result;
                        hidePlaceholder();
                    }
                };
                reader.readAsDataURL(file);
                
                // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/api/upload_screenshot', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const img = document.getElementById('screenshot-img');
                        if (img) {
                            img.src = data.url;
                        }
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ø–∞–ø–∞ —á–∞—Ç–∞
        function openChatPopup() {
            const popup = document.getElementById('chatPopup');
            if (popup) {
                popup.classList.add('show');
                document.body.style.overflow = 'hidden'; // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª —Ñ–æ–Ω–∞
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                resetChatState();
            }
        }

        function closeChatPopup() {
            const popup = document.getElementById('chatPopup');
            if (popup) {
                popup.classList.remove('show');
                document.body.style.overflow = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                resetChatState();
            }
        }

        function resetChatState() {
            const initialContent = document.getElementById('initialContent');
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            const chatMessages = document.getElementById('chatMessages');
            const chatInputContainer = document.getElementById('chatInputContainer');
            const chatInput = document.getElementById('chatInput');
            
            if (initialContent) {
                initialContent.style.display = 'block';
            }
            if (chatMessagesContainer) {
                chatMessagesContainer.style.display = 'none';
            }
            if (chatInputContainer) {
                chatInputContainer.style.display = 'none';
            }
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            if (chatInput) {
                chatInput.value = '';
            }
        }

        function closeChatPopupOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closeChatPopup();
            }
        }

        function handleShowAnalysis() {
            const chatBody = document.getElementById('chatBody');
            const initialContent = document.getElementById('initialContent');
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            const chatMessages = document.getElementById('chatMessages');
            const chatInputContainer = document.getElementById('chatInputContainer');
            
            if (!chatBody) return;

            // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
            if (initialContent) {
                initialContent.style.display = 'none';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (chatMessagesContainer) {
                chatMessagesContainer.style.display = 'block';
            }
            if (chatInputContainer) {
                chatInputContainer.style.display = 'flex';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ —Å –∞–Ω–∞–ª–∏–∑–æ–º
            if (chatMessages) {
                const analysisHTML = `
                    <div class="message message-bot">
                        <div class="message-bubble">
                            <p>–°–º–æ—Ç—Ä–∏, —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.</p>
                            
                            <p>–í —Å—Ä–µ–¥–Ω–µ–º, —Ü–µ–Ω—ã –≤ –ñ–ö –Ω–∞ <strong>3% –Ω–∏–∂–µ</strong> —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.</p>
                            
                            <p>–î–∞–ª–µ–µ, —è —Ä–∞–∑–¥–µ–ª–∏–ª –≤—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ –≥—Ä—É–ø–ø–∞–º:</p>
                            <p><strong>–∫–æ–º–Ω–∞—Ç–Ω–æ—Å—Ç—å √ó –æ–±—â–∞—è –ø–ª–æ—â–∞–¥—å √ó —ç—Ç–∞–∂ √ó –≤–∏–¥ –∏–∑ –æ–∫–æ–Ω</strong></p>
                            
                            <p>–ü–æ–ª—É—á–∏–ª–æ—Å—å 10 –≥—Ä—É–ø–ø (–≤ —Å–∫–æ–±–∫–∞—Ö —É–∫–∞–∑–∞–Ω–∞ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Ü–µ–Ω–µ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø–µ):</p>
                            
                            <ol class="analysis-groups" style="margin: 12px 0; padding-left: 20px;">
                                <li>1–∫, –Ω–µ –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 10-20 –º¬≤ (<span class="price-diff negative">-3%</span>)</li>
                                <li>1–∫, –Ω–µ –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 20-30 –º¬≤ (<span class="price-diff negative">-3%</span>)</li>
                                <li>1–∫, –Ω–µ –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 30-40 –º¬≤ (<span class="price-diff negative">-3%</span>)</li>
                                <li>1–∫, –Ω–µ –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 40-50 –º¬≤ (<span class="price-diff positive">+3%</span>)</li>
                                <li>1–∫, –Ω–µ –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 50-60 –º¬≤ (<span class="price-diff negative">-3,6%</span>)</li>
                                <li>1–∫, –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 10-20 –º¬≤ (<span class="price-diff positive">+2%</span>)</li>
                                <li>1–∫, –ø–µ—Ä–≤—ã–π, –Ω–∞ —É–ª–∏—Ü—É, 20-30 –º¬≤ (<span class="price-diff negative">-3%</span>)</li>
                            </ol>
                            
                            <p>–¢–∞–∫–∂–µ —Å—Ä–µ–¥–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —è –Ω–∞—à–µ–ª –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –∫–≤–∞—Ä—Ç–∏—Ä—ã ¬´–ª–∏–¥-–º–∞–≥–Ω–∏—Ç—ã¬ª, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ. –¢–∞–∫–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã —è –∏—Å–∫–ª—é—á–∏–ª –Ω–∞ —ç—Ç–∞–ø–µ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã.</p>
                            
                            <br>
                            
                            <p style="margin-top: 12px;">–ö–∞–∫–∏–µ –ø–æ–¥—Ç–∏–ø—ã –∫–≤–∞—Ä—Ç–∏—Ä —Ö–æ—á–µ—à—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ?</p>
                        </div>
                    </div>
                `;
                chatMessages.innerHTML = analysisHTML;
            }
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.focus();
                }
                scrollChatToBottom();
            }, 100);
        }

        function sendUserMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatMessages = document.getElementById('chatMessages');
            
            if (!chatInput || !chatMessages) return;
            
            const messageText = chatInput.value.trim();
            if (!messageText) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userMessageHTML = `
                <div class="message message-user">
                    <div class="message-bubble">${escapeHtml(messageText)}</div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', userMessageHTML);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            chatInput.value = '';
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            scrollChatToBottom();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                showBotResponse();
            }, 500);
        }

        function showBotResponse() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            const botResponseHTML = `
                <div class="message message-bot">
                    <div class="message-bubble">
                        –°—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç—É–¥–∏–π –≤ —Å—Ä–µ–¥–Ω–µ–º –≤ –ñ–ö –Ω–∏–∂–µ –Ω–∞ 1,5% –•–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ü–µ–Ω—ã?
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', botResponseHTML);
            scrollChatToBottom();
        }

        function handleChatInputKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendUserMessage();
            }
        }

        function scrollChatToBottom() {
            const chatMessagesContainer = document.getElementById('chatMessagesContainer');
            if (chatMessagesContainer) {
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeChatPopup();
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            const img = document.getElementById('screenshot-img');
            const fileInput = document.getElementById('file-input');
            
            if (img) {
                img.addEventListener('error', showPlaceholder);
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                if (!img.complete || img.naturalWidth === 0) {
                    setTimeout(function() {
                        if (!img.complete || img.naturalWidth === 0) {
                            showPlaceholder();
                        }
                    }, 100);
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        loadImageFromFile(e.target.files[0]);
                    }
                });
            }
        });
    </script>
</body>
</html>
