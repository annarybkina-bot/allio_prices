# Техническое задание: Генератор ежемесячных отчетов по технической поддержке

## 1. Описание задачи

Необходимо разработать скрипт для автоматической генерации ежемесячного отчета по технической поддержке на основе данных из CSV файла. Отчет должен включать статистику обращений, динамику по месяцам, анализ по типам обращений, SLA метрики и аналитические выводы. Результат должен быть представлен в виде HTML файла с минималистичным дизайном и визуализациями.

## 2. Входные данные

### 2.1. Формат файлов
- **Формат**: CSV файлы с кодировкой UTF-8, UTF-8-sig, CP1251 или Windows-1251
- **Разделитель**: запятая
- **Источник**: Экспорт данных из системы учета задач (Helpdesk)

### 2.2. Структура входных CSV файлов

CSV файл должен содержать следующие обязательные колонки:

- `Создана` - дата создания обращения в формате "28 дек. 2025" (день, месяц, год)
- `Тип` - тип обращения (значения: "Вопрос", "Проблема", "Пожелание")
- `Застройщик` - название застройщика/проекта (используется для определения внешний/внутренний пользователь)
- `Первая реакция` - время первой реакции в минутах (число)
- `Время решения` - время решения в минутах (число)

**Примечание**: Названия колонок могут содержать пробелы в начале или конце, которые должны автоматически удаляться при обработке.

### 2.3. Параметры запуска скрипта

Скрипт должен принимать три аргумента командной строки:
1. **Месяц** - число от 1 до 12 (1 = январь, 12 = декабрь)
2. **Год** - число (например, 2025, 2026)
3. **Путь к CSV файлу** - полный путь к файлу с данными за указанный месяц

**Пример использования:**
```bash
python3 generate_monthly_report.py 12 2025 "/Users/user/Downloads/Задачи-декабрь.csv"
```

## 3. Обработка данных

### 3.1. Парсинг даты

- **Формат входных данных**: "28 дек. 2025" (день, сокращенное название месяца, год)
- **Поддерживаемые месяцы**: янв, фев, мар, апр, май, июн, июл, авг, сен, окт, ноя, дек
- **Логика**: 
  - Разделить строку по пробелам
  - Извлечь день (первое число)
  - Определить месяц по первым 3 символам второго слова
  - Извлечь год (третье число)
- **Результат**: объект datetime или None при ошибке парсинга

### 3.2. Определение типа пользователя

- **Поле**: `Застройщик`
- **Внутренние пользователи** (dev/demo):
  - Содержат "allio dev" (регистронезависимо)
  - Содержат "allio demo" (регистронезависимо)
  - Равны "demo" (регистронезависимо)
- **Внешние пользователи** (prod): все остальные
- **Результат**: булево значение (True = внешний, False = внутренний, None = не определено)

### 3.3. Категоризация первой реакции

- **Входные данные**: время в минутах (число)
- **Категории**:
  - "Меньше 15м" - если < 15 минут
  - "От 15м до 1ч" - если >= 15 и < 60 минут
  - "от 1ч до 1д" - если >= 60 и < 1440 минут (24 часа)
  - "Более 1д" - если >= 1440 минут
  - "Неизвестно" - если значение отсутствует или не может быть распознано

### 3.4. Категоризация времени решения

- **Входные данные**: время в минутах (число)
- **Категории**:
  - "Меньше 1ч" - если < 60 минут
  - "От 1ч до 1д" - если >= 60 и < 1440 минут (24 часа)
  - "От 1д до 1н" - если >= 1440 и < 10080 минут (7 дней)
  - "Более 1н" - если >= 10080 минут
  - "Неизвестно" - если значение отсутствует или не может быть распознано

### 3.5. Фильтрация данных

- **По месяцу и году**: отфильтровать обращения, где дата создания соответствует указанным месяцу и году
- **По году**: отфильтровать все обращения за указанный год (для расчета динамики)

## 4. Структура отчета

Отчет должен состоять из 7 основных разделов:

### 4.1. Шаг 1: Статистика обращений за месяц

**Содержание:**
- Всего обращений за месяц (число)
- Внешние пользователи (prod) (число)
- Внутренние пользователи (dev и demo) (число)
- Обращений за год (число, с разбивкой на внешние/внутренние)

**Формат отображения:**
```
• Всего обращений за декабрь — 183
• Внешние пользователи (prod) — 176
• Внутренние пользователи (dev и demo) — 8
• Обращений за 2025 год — 2184 (внешних - 1954, внутренних - 230)
```

### 4.2. Шаг 2: Динамика количества обращений по месяцам

**Содержание:**
- Таблица с данными за все 12 месяцев года:
  - Месяц
  - Общее кол-во
  - Внешние
  - Внутренние
  - Прирост (внешние) - процентное изменение относительно предыдущего месяца
- График динамики (столбчатая диаграмма + линия):
  - Два столбца: внешние (зеленый) и внутренние (красный)
  - Линия поверх: общее количество (синий)
  - Ось X: месяцы (сокращенные названия)
  - Ось Y: количество обращений

**Формат таблицы:**
| Месяц | Общее кол-во | Внешние | Внутренние | Прирост (внешние) |
|-------|--------------|---------|------------|-------------------|
| Январь | 182 | **159** | 21 | 0% |
| Февраль | 257 | **191** | 66 | +20.13% |

### 4.3. Шаг 3: Соотношение типов обращений

**Содержание:**
- Таблица с разбивкой по типам обращений:
  - Тип (Вопрос, Проблема, Пожелание)
  - Общее кол-во
  - Внешние
  - Внутренние
  - Доля внешних от общего за месяц (в процентах)
- Итоговая строка "Всего"

**Формат таблицы:**
| Тип | Общее кол-во | Внешние | Внутренние | Доля внешних от общего за месяц |
|-----|--------------|---------|------------|--------------------------------|
| Вопрос | 114 | **111** | 3 | 97.37% |
| Проблема | 30 | **28** | 2 | 93.33% |
| Пожелание | 46 | **43** | 3 | 93.48% |
| **Всего** | **190** | **182** | **8** | **95.79%** |

### 4.4. Шаг 4: Динамика по типам (только внешние)

**Содержание:**
- Таблица с данными по месяцам для каждого типа обращений (только внешние пользователи):
  - Месяц
  - Вопрос
  - Проблема
  - Пожелание
- График динамики по типам (столбчатая диаграмма):
  - Три столбца для каждого месяца: Вопрос (синий), Проблема (красный), Пожелание (зеленый)
  - Ось X: месяцы (сокращенные названия)
  - Ось Y: количество обращений

**Формат таблицы:**
| Месяц | Вопрос | Проблема | Пожелание |
|-------|--------|----------|-----------|
| Январь | 74 | 30 | 55 |
| Февраль | 86 | 45 | 60 |
| ... | ... | ... | ... |
| Декабрь | 111 | 28 | 43 |

### 4.5. Шаг 5: Выводы по динамике обращений (внешние)

**Содержание:**
Аналитические выводы, сгенерированные автоматически на основе данных:

**5.1. Вопросы:**
- Сравнение с предыдущим месяцем (рост/снижение/стабильность)
- Сравнение с максимумом/минимумом за год
- Сравнение с предыдущим-предыдущим месяцем (если доступно)
- Доля вопросов от всех внешних обращений
- Выводы о причинах изменений

**5.2. Проблемы:**
- Сравнение с предыдущим месяцем
- Сравнение с минимумом/максимумом за год
- Сравнение с предыдущим-предыдущим месяцем
- Доля проблем от всех внешних обращений
- Выводы о стабильности системы

**5.3. Пожелания:**
- Сравнение с предыдущим месяцем
- Сравнение с предыдущим-предыдущим месяцем
- Доля пожеланий от всех внешних обращений
- Сравнение со средним за год
- Выводы об активности пользователей

**5.4. Итоговые выводы:**
- Общий поток внешних обращений (динамика)
- Структура обращений (доминирующий тип)
- Показатели стабильности системы
- Особенности текущего периода

**Формат:**
- Структурированный текст с заголовками и списками
- Конкретные числа и проценты
- Аналитические выводы с объяснениями

**Пример структуры:**
```html
<h3>Вопросы</h3>
<ul>
  <li>В декабре количество вопросов осталось на прежнем уровне — 111 (как и в ноябре).</li>
  <li>Это максимальный показатель за весь год (максимум: 111, среднее за год: 83.7).</li>
  <li>Вопросы составляют 61.9% от всех внешних обращений в декабре — это доминирующий тип обращений.</li>
</ul>
```

### 4.6. Шаг 6: Таблицы по SLA

**6.1. Первая реакция:**

**Таблица:**
| Тип обращения | Меньше 15м | От 15м до 1ч | от 1ч до 1д |
|---------------|------------|--------------|-------------|
| Вопрос | 111 | 3 | 0 |
| Проблема | 28 | 1 | 1 |
| Пожелание | 43 | 1 | 2 |

**Визуализация:**
- Три круговые диаграммы (по одной для каждого типа обращения)
- Каждая диаграмма показывает распределение по категориям времени первой реакции
- На диаграммах отображаются проценты и общее количество обращений
- Цвета: зеленый (Меньше 15м), оранжевый (От 15м до 1ч), красный (от 1ч до 1д)

**6.2. Время решения:**

**Таблица:**
| Тип обращения | Меньше 1ч | От 1ч до 1д | От 1д до 1н | Более 1н | Неизвестно |
|---------------|-----------|-------------|------------|---------|------------|
| Вопрос | 19 | 43 | 34 | 2 | 11 |
| Проблема | 12 | 11 | 3 | 0 | 0 |
| Пожелание | 17 | 11 | 8 | 2 | 3 |

**Визуализация:**
- Три круговые диаграммы (по одной для каждого типа обращения)
- Каждая диаграмма показывает распределение по категориям времени решения
- На диаграммах отображаются проценты и общее количество обращений
- Цвета: зеленый (Меньше 1ч), светло-зеленый (От 1ч до 1д), оранжевый (От 1д до 1н), красный (Более 1н), серый (Неизвестно)

### 4.7. Шаг 7: Общие итоги

**Содержание:**
- Общий процент обращений, получивших ответ менее чем за 15 минут
- Сравнение типов обращений по скорости реакции
- Детализация по типам (количество и процент для каждого типа)
- Заключительное замечание о единичных случаях

**Формат:**
```html
<p><strong>Большинство обращений (95.79%) получают ответ в течение первых 15 минут.</strong></p>
<p>Проблемы решаются быстрее других типов, а вопросы — наиболее длительные (поставлена задача по воркфлоу, пока на паузе из-за более высоких приоритетов других задач).</p>

<h3>По типам:</h3>
<ul>
  <li><strong>Вопросы:</strong> 111 из 114 (97.37%) — ответ менее чем за 15 минут.</li>
  <li><strong>Проблемы:</strong> 28 из 30 (93.33%) — ответ менее чем за 15 минут.</li>
  <li><strong>Пожелания:</strong> 43 из 46 (93.48%) — ответ менее чем за 15 минут.</li>
</ul>

<p>Лишь единичные случаи требуют большего времени на первичную реакцию — чаще всего это обращения, где нужно более глубокое тестирование или уточнение у разработчиков.</p>
```

## 5. Визуализации

### 5.1. Требования к графикам

- **Библиотека**: matplotlib с backend 'Agg' (для работы без GUI)
- **Формат вывода**: base64-encoded PNG изображения, встроенные в HTML
- **Разрешение**: 150 DPI
- **Стиль**: профессиональный, читаемый

### 5.2. Типы графиков

1. **Динамика обращений по месяцам** (столбчатая диаграмма + линия)
   - Размер: 14x8 дюймов
   - Два столбца: внешние (зеленый #2e7d32) и внутренние (красный #d32f2f)
   - Линия: общее количество (синий #1976d2)
   - Сетка: полупрозрачная, только по оси Y

2. **Динамика по типам обращений** (столбчатая диаграмма)
   - Размер: 14x8 дюймов
   - Три столбца: Вопрос (синий #1976d2), Проблема (красный #d32f2f), Пожелание (зеленый #388e3c)
   - Сетка: полупрозрачная, только по оси Y

3. **Первая реакция** (три круговые диаграммы)
   - Размер: 18x6 дюймов (три диаграммы в ряд)
   - Цвета: зеленый (#4caf50), оранжевый (#ff9800), красный (#f44336)
   - Проценты отображаются белым цветом, жирным шрифтом

4. **Время решения** (три круговые диаграммы)
   - Размер: 18x6 дюймов (три диаграммы в ряд)
   - Цвета: зеленый (#4caf50), светло-зеленый (#8bc34a), оранжевый (#ff9800), красный (#f44336), серый (#9e9e9e)
   - Проценты отображаются белым цветом, жирным шрифтом

### 5.3. Обработка ошибок визуализации

- Если matplotlib/numpy не установлены, отчет должен быть создан без графиков
- В местах графиков должен быть текст "График недоступен" или пустое место
- Скрипт должен продолжать работу даже при ошибках создания графиков

## 6. Дизайн HTML отчета

### 6.1. Минималистичный стиль

**Принципы:**
- Белый фон (#fff), черный текст (#000)
- Минимум декоративных элементов
- Четкая типографика
- Простые таблицы с тонкими границами

**Цветовая схема:**
- Фон: белый (#fff)
- Текст: черный (#000)
- Заголовки таблиц: светло-серый фон (#f5f5f5), черная нижняя граница (2px solid #000)
- Границы таблиц: светло-серый (#e0e0e0)
- Важные числа: жирный черный шрифт

### 6.2. Типографика

- **Шрифт**: системный sans-serif (-apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif)
- **Заголовок H1**: 28px, жирный, отступ снизу 30px
- **Заголовок H2**: 22px, жирный, отступ сверху 50px, снизу 20px
- **Заголовок H3**: 16px, жирный, отступ сверху 25px, снизу 15px
- **Основной текст**: 14px, межстрочный интервал 1.6
- **Таблицы**: шрифт 14px

### 6.3. Структура страницы

- **Максимальная ширина**: 1200px
- **Отступы**: 40px сверху/снизу, 20px слева/справа
- **Межблочные отступы**: 25-50px между секциями

### 6.4. Таблицы

- **Границы**: 1px solid #e0e0e0
- **Заголовки**: фон #f5f5f5, нижняя граница 2px solid #000
- **Ячейки**: отступы 10-15px
- **Важные числа**: жирный шрифт
- **Итоговые строки**: фон #f5f5f5, жирный шрифт

### 6.5. Графики

- **Контейнер**: белый фон, отступы 30px сверху/снизу
- **Изображения**: максимальная ширина 100%, граница 1px solid #e0e0e0
- **Заголовки графиков**: 16px, жирный, отступ снизу 20px

### 6.6. Выводы и итоги

- **Фон**: белый (без фоновых блоков)
- **Списки**: отступ слева 25px, межстрочный интервал 1.7
- **Параграфы**: отступы 15px сверху/снизу

## 7. Выходные данные

### 7.1. Формат файла

- **Формат**: HTML файл
- **Кодировка**: UTF-8
- **Имя файла**: `Отчет_техподдержка_<месяц>_<год>.html`
  - Пример: `Отчет_техподдержка_декабрь_2025.html`
  - Пример: `Отчет_техподдержка_январь_2026.html`

### 7.2. Расположение файла

- Файл сохраняется в директории, указанной в параметрах скрипта (по умолчанию: рабочая директория скрипта)

### 7.3. Дополнительные возможности

- Отчет можно конвертировать в PDF через браузер:
  1. Открыть HTML файл в Safari или Chrome
  2. Нажать Cmd+P (Печать)
  3. Выбрать "PDF" → "Сохранить как PDF"

## 8. Обработка ошибок

### 8.1. Валидация входных данных

- Проверка наличия CSV файла
- Проверка корректности месяца (1-12)
- Проверка корректности года (положительное число)
- Вывод понятных сообщений об ошибках

### 8.2. Обработка отсутствующих данных

- Если не найдено обращений за указанный месяц - вывести предупреждение, но создать отчет
- Если отсутствуют данные за некоторые месяцы - пропустить их в таблицах
- Если отсутствуют данные для типа обращения - показать 0 в таблицах

### 8.3. Обработка ошибок парсинга

- Некорректные даты - пропустить запись, вывести предупреждение
- Некорректные числа - использовать значение по умолчанию (None)
- Отсутствующие колонки - использовать значения по умолчанию

## 9. Требования к реализации

### 9.1. Язык программирования

- Python 3.6+

### 9.2. Зависимости

- **Обязательные**: csv (встроенный), datetime (встроенный), collections (встроенный), pathlib (встроенный), re (встроенный), base64 (встроенный), io (встроенный)
- **Опциональные**: matplotlib, numpy (для визуализаций)

### 9.3. Структура кода

- Модульная структура с отдельными функциями для каждой задачи
- Четкое разделение: загрузка данных, обработка, расчет статистики, генерация визуализаций, генерация HTML
- Комментарии на русском языке
- Обработка ошибок на каждом этапе

### 9.4. Производительность

- Скрипт должен обрабатывать файлы с несколькими тысячами записей за разумное время (< 30 секунд)
- Оптимизация работы с памятью при больших объемах данных

## 10. Примеры использования

### 10.1. Базовый пример

```bash
python3 generate_monthly_report.py 12 2025 "/Users/user/Downloads/Задачи-декабрь.csv"
```

**Результат:**
- Создан файл `Отчет_техподдержка_декабрь_2025.html`
- Отчет содержит все 7 шагов с данными за декабрь 2025
- Включены все визуализации (если установлен matplotlib)

### 10.2. Пример с данными за другой месяц

```bash
python3 generate_monthly_report.py 1 2026 "/Users/user/Downloads/Задачи-январь-2026.csv"
```

**Результат:**
- Создан файл `Отчет_техподдержка_январь_2026.html`
- Отчет содержит данные за январь 2026
- Динамика рассчитывается на основе всех данных за 2026 год из файла

## 11. Дополнительные требования

### 11.1. Логирование

- Вывод прогресса выполнения в консоль:
  - "Загрузка данных из ..."
  - "Загружено обращений: N"
  - "Фильтрация данных за M/Y..."
  - "Обращений за месяц: N"
  - "Генерация отчета..."
  - "✓ Отчет сохранен: путь/к/файлу"

### 11.2. Обратная совместимость

- Скрипт должен работать с различными вариантами названий колонок (с пробелами, в разных регистрах)
- Поддержка различных кодировок CSV файлов
- Graceful degradation при отсутствии опциональных библиотек

### 11.3. Расширяемость

- Код должен быть легко расширяем для добавления новых метрик
- Легко изменяемые параметры (цвета, размеры графиков, стили)

## 12. Критерии приемки

Отчет считается успешно сгенерированным, если:

1. ✅ Все 7 шагов присутствуют в HTML файле
2. ✅ Все таблицы заполнены корректными данными
3. ✅ Все графики созданы и встроены в HTML (если matplotlib установлен)
4. ✅ Дизайн соответствует минималистичному стилю
5. ✅ Выводы сгенерированы автоматически на основе данных
6. ✅ Файл открывается в браузере без ошибок
7. ✅ Данные в таблицах соответствуют исходным данным из CSV
8. ✅ Расчеты (проценты, приросты) выполнены корректно

## 13. Примечания

- Скрипт должен быть кроссплатформенным (работать на macOS, Linux, Windows)
- При работе в sandbox окружении могут быть ограничения на установку библиотек - скрипт должен работать и без визуализаций
- Для конвертации в PDF рекомендуется использовать встроенные возможности браузера, так как автоматическая конвертация может требовать дополнительных зависимостей
